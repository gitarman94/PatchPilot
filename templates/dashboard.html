<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PatchPilot Dashboard</title>

    <!-- Bootstrap 5 -->
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
          crossorigin="anonymous">

    <!-- DataTables (search, sort, pagination, export, column‚Äëvisibility) -->
    <link rel="stylesheet"
          href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css"/>
    <link rel="stylesheet"
          href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css"/>
    <link rel="stylesheet"
          href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.dataTables.min.css"/>

    <!-- Font Awesome for icons -->
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
          crossorigin="anonymous"/>

    <style>
        :root {
            --bg-light: #f9f9f9;
            --bg-dark:  #121212;
            --text-light: #212529;
            --text-dark: #e5e5e5;
            --primary: #0d6efd;
            --primary-dark: #1e90ff;
        }
        body { background: var(--bg-light); color: var(--text-light); transition: background .3s, color .3s; }
        body.dark-mode { background: var(--bg-dark); color: var(--text-dark); }
        .status-online { color:#28a745; font-weight:bold; }
        .status-offline { color:#dc3545; font-weight:bold; }
        .status-updates { color:#ffc107; font-weight:bold; }
        .toast-container { position:fixed; top:1rem; right:1rem; z-index:1055; }
        .modal-body { min-height:200px; }
    </style>
</head>
<body>
<div class="container py-4">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h3"><i class="fa-solid fa-toolbox me-2"></i>PatchPilot Dashboard</h1>
        <button id="darkModeToggle" class="btn btn-outline-secondary">
            <i class="fa-solid fa-moon"></i>
        </button>
    </div>

    <!-- DataTable -->
    <table id="clientsTable" class="display nowrap table table-striped table-hover"
           style="width:100%">
        <thead>
        <tr>
            <th>Client ID</th>
            <th>Hostname</th>
            <th>OS</th>
            <th>CPU</th>
            <th>RAM</th>
            <th>Disk</th>
            <th>Patch Status</th>
            <th>Uptime</th>
            <th>Status</th>
            <th>Updates</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody>
        {% for client in clients %}
        <tr data-client-id="{{ client.id }}">
            <td><a href="#" class="client-link text-primary">{{ client.id }}</a></td>
            <td>{{ client.client_name or '‚Äî' }}</td>
            <td>{{ client.os_name or '‚Äî' }}</td>
            <td>{{ client.cpu or '‚Äî' }}</td>
            <td>{{ client.ram or '‚Äî' }}</td>
            <td>{{ client.disk_total or '‚Äî' }}/{{ client.disk_free or '‚Äî' }}</td>
            <td>
                {% if client.updates_available %}
                    <span class="badge bg-warning text-dark">‚ö†Ô∏è Pending</span>
                {% else %}
                    <span class="badge bg-success">‚úÖ Up‚Äëto‚Äëdate</span>
                {% endif %}
            </td>
            <td>{{ client.uptime or '‚Äî' }}</td>
            <td>
                {% if client.last_checkin and (now - client.last_checkin).total_seconds() < 600 %}
                    <span class="status-online">üü¢ Online</span>
                {% else %}
                    <span class="status-offline">üî¥ Offline</span>
                {% endif %}
            </td>
            <td>
                {% if client.updates_available %}
                    <span class="status-updates">‚ö†Ô∏è Yes</span>
                {% else %}
                    <span class="status-updates">‚úÖ No</span>
                {% endif %}
            </td>
            <td class="text-nowrap">
                {% if not client.approved %}
                    <button class="btn btn-sm btn-outline-success approve-btn" title="Approve">
                        <i class="fa-solid fa-check"></i>
                    </button>
                {% endif %}
                <button class="btn btn-sm btn-outline-warning force-btn" title="Force update">
                    <i class="fa-solid fa-rotate"></i>
                </button>
                <button class="btn btn-sm btn-outline-info checkin-btn" title="Allow check‚Äëin">
                    <i class="fa-solid fa-check-double"></i>
                </button>
            </td>
        </tr>
        {% endfor %}
        </tbody>
    </table>

    <!-- Toast container -->
    <div class="toast-container"></div>

    <!-- Detail modal (filled via AJAX) -->
    <div class="modal fade" id="clientDetailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Client Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="clientDetailBody">
                    <div class="text-center py-5"><div class="spinner-border" role="status"></div></div>
                </div>
            </div>
        </div>
    </div>

</div>

<script src="https://code.jquery.com/jquery-3.7.0.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
        crossorigin="anonymous"></script>

<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>

<script>
/* persist dark mode */
if (localStorage.getItem('darkMode') === 'enabled') document.body.classList.add('dark-mode');
document.getElementById('darkModeToggle').addEventListener('click', () => {
    document.body.classList.toggle('dark-mode');
    localStorage.setItem('darkMode',
        document.body.classList.contains('dark-mode') ? 'enabled' : 'disabled');
});

/* toast helper */
function showToast(message, type='success') {
    const toast = $(` 
        <div class="toast align-items-center text-bg-${type} border-0 mb-2" role="alert">
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto"
                        data-bs-dismiss="toast"></button>
            </div>
        </div>`);
    $('.toast-container').append(toast);
    const bsToast = new bootstrap.Toast(toast[0], {delay:3000});
    bsToast.show();
}

/* DataTables init with export/column‚Äëvisibility */
const table = $('#clientsTable').DataTable({
    responsive:true,
    pageLength:10,
    dom:'Bfrtip',
    buttons:[
        {extend:'colvis', text:'Columns'},
        {extend:'csv',   text:'CSV'},
        {extend:'excel', text:'Excel'},
        {extend:'pdf',   text:'PDF'},
        {extend:'print', text:'Print'}
    ],
    columnDefs:[
        {orderable:false, targets:[10]}
    ]
});

/* generic POST helper (adds admin token) */
function postAction(url, successMsg) {
    $.post(url, {'admin_token':'{{ ADMIN_TOKEN or "" }}'})
        .done(() => showToast(successMsg))
        .fail(() => showToast('Action failed','danger'));
}

/* row‚Äëlevel buttons */
$('#clientsTable').on('click', '.approve-btn', function(){
    const id = $(this).closest('tr').data('client-id');
    postAction(`/approve/${id}`, `Client ${id} approved`);
});

$('#clientsTable').on('click', '.force-btn', function(){
    const id = $(this).closest('tr').data('client-id');
    postAction(`/admin/force-update/${id}`, `Force update sent to ${id}`);
});

$('#clientsTable').on('click', '.checkin-btn', function(){
    const id = $(this).closest('tr').data('client-id');
    postAction(`/admin/allow-checkin/${id}`, `Check‚Äëin allowed for ${id}`);
});

/* load client details into modal */
$('#clientsTable').on('click', '.client-link', function(e){
    e.preventDefault();
    const clientId = $(this).closest('tr').data('client-id');
    const modal = new bootstrap.Modal('#clientDetailModal');
    $('#clientDetailBody').html(`
        <div class="text-center py-5"><div class="spinner-border" role="status"></div></div>
    `);
    modal.show();
    $.get(`/clients/${clientId}`)
        .done(html => $('#clientDetailBody').html(html))
        .fail(() => $('#clientDetailBody').html('<p class="text-danger">Failed to load details.</p>'));
});
</script>
</body>
</html>


