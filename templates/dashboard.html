<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PatchPilot — Dashboard</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>

  <!-- DataTables -->
  <link href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" rel="stylesheet"/>
  <link href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.dataTables.min.css" rel="stylesheet"/>

  <style>
    :root {
      --sidebar-width: 240px;
      --sidebar-collapsed: 70px;
      --bg:#f6f8fb;
      --card:#ffffff;
      --accent:#0d6efd;
      --muted:#6c757d;
      --text:#0b1720;
      --table-head:#f1f3f5;
    }

    body { background:var(--bg); color:var(--text); font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .app-shell { display:flex; min-height:100vh; }
    .sidebar {
      width:var(--sidebar-width);
      background:var(--card);
      border-right:1px solid rgba(0,0,0,0.04);
      transition: width .18s ease;
      display:flex;
      flex-direction:column;
      padding:1rem 0.5rem;
    }
    .sidebar.collapsed { width:var(--sidebar-collapsed); }
    .nav-item { display:flex; align-items:center; gap:.75rem; padding:.55rem .6rem; border-radius:8px; cursor:pointer; color:var(--text); }
    .nav-item:hover { background:rgba(13,110,253,0.05); }
    .nav-item.active { background: linear-gradient(90deg, rgba(13,110,253,0.08), rgba(13,110,253,0.03)); border-left:4px solid var(--accent); padding-left:.35rem; }
    .nav-icon { width:36px; text-align:center; font-size:1.15rem; color:var(--accent); }
    .nav-label { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .sidebar .brand { display:flex; align-items:center; gap:.6rem; padding:.4rem .6rem; margin-bottom:0.25rem; }
    .brand img { height:30px; width:30px; object-fit:contain; }

    .sidebar-footer { margin-top:auto; padding:.5rem; display:flex; align-items:center; justify-content:center; gap:.5rem; }
    .collapse-toggle { width:100%; }

    .content { flex:1; padding:1rem; min-width:0; }
    .topbar { display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; gap:1rem; }

    /* collapsed state adjustments */
    .sidebar.collapsed .nav-label, .sidebar.collapsed .brand-text { display:none; }
    .sidebar.collapsed .brand { justify-content:center; }
    .sidebar.collapsed .nav-item { justify-content:center; padding: .5rem 0; }
    .sidebar.collapsed .sidebar-footer { justify-content:center; }

    /* Small screens */
    @media (max-width:900px) {
      .sidebar { position:fixed; z-index:1050; height:100vh; left:-100%; }
      .sidebar.open { left:0; }
      .content { padding-top:70px; }
    }

    /* Card tweaks */
    .summary-grid { display:grid; grid-template-columns: repeat(4,1fr); gap:12px; margin-bottom:1rem; }
    .summary-card { padding:12px; border-radius:8px; background:var(--card); box-shadow:0 1px 2px rgba(16,24,40,.04); }
    .value { font-size:1.45rem; font-weight:600; }
    .small-muted { color:var(--muted); font-size:.9rem; }

    /* DataTables fixes for card background */
    .card, .card-body { background:var(--card); }
    .table-responsive { background:transparent; }
    .badge-pending { background:linear-gradient(90deg,#fff3cd,#fff8e1); color:#6b4b00; border:1px solid rgba(0,0,0,.04); }
    .status-dot { display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:.5rem; }
    .status-online { background:#198754; }
    .status-offline { background:var(--muted); }
    .status-pending { background:#ffc107; }

    /* Pending list actions */
    #pendingActions { display:flex; gap:.5rem; align-items:center; }
    #health-grid { display:grid; grid-template-columns: repeat(3,1fr); gap:12px; }
    @media (max-width:1100px) { .summary-grid { grid-template-columns:repeat(2,1fr); } .health-grid { grid-template-columns:1fr; } .sidebar { display:none; } }
  </style>
</head>
<body>
  <div class="app-shell">
    <nav id="sidebar" class="sidebar" aria-label="Main navigation">
      <div class="brand ps-2 pe-2">
        <img src="/static/favicon.ico" alt="logo">
        <div class="brand-text">
          <div class="brand h6 mb-0">PatchPilot</div>
          <div class="small-muted">Device management</div>
        </div>
      </div>

      <div id="navList" class="px-1" role="navigation">
        <div class="nav-item active" data-view="devices" tabindex="0">
          <div class="nav-icon"><i class="bi bi-hdd-network"></i></div>
          <div class="nav-label">Devices</div>
        </div>

        <div class="nav-item" data-view="pending" tabindex="0">
          <div class="nav-icon"><i class="bi bi-hourglass-split"></i></div>
          <div class="nav-label">Pending Adoption</div>
        </div>

        <div class="nav-item" data-view="health" tabindex="0">
          <div class="nav-icon"><i class="bi bi-activity"></i></div>
          <div class="nav-label">Health</div>
        </div>

        <hr/>

        <div class="nav-item" id="refreshNav" title="Refresh data" tabindex="0">
          <div class="nav-icon"><i class="bi bi-arrow-clockwise"></i></div>
          <div class="nav-label">Refresh</div>
        </div>
      </div>

      <div class="sidebar-footer">
        <button id="toggleSidebar" class="btn btn-outline-secondary btn-sm collapse-toggle" title="Collapse navigation">
          <span id="toggleIcon"><i class="bi bi-chevron-left"></i></span>
          <span id="toggleLabel" style="margin-left:.5rem;">Collapse</span>
        </button>
      </div>
    </nav>

    <main class="content">
      <div class="topbar">
        <div>
          <h4 class="mb-0">PatchPilot</h4>
          <div class="small-muted">Device management & patch orchestration</div>
        </div>

        <div class="d-flex gap-2 align-items-center">
          <button id="btnRefresh" class="btn btn-outline-secondary btn-sm"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
          <button id="btnToggleDark" class="btn btn-outline-secondary btn-sm"><i class="bi bi-moon"></i></button>
        </div>
      </div>

      <section id="view-devices" class="view">
        <div class="summary-grid mb-3">
          <div class="summary-card">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <div class="small-muted">Total devices</div>
                <div id="totalDevices" class="value">—</div>
              </div>
              <div class="text-end">
                <small class="small-muted">Updated</small><br/>
                <small id="lastRefresh" class="small-muted">—</small>
              </div>
            </div>
          </div>
          <div class="summary-card">
            <div class="small-muted">Online</div>
            <div id="onlineDevices" class="value">—</div>
          </div>
          <div class="summary-card">
            <div class="small-muted">Pending approval</div>
            <div id="pendingCount" class="value">—</div>
          </div>
          <div class="summary-card">
            <div class="small-muted">Updates available</div>
            <div id="updatesAvailable" class="value">—</div>
          </div>
        </div>

        <div class="card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="mb-0">Devices</h5>
              <div class="small-muted">Showing approved + pending</div>
            </div>

            <div class="table-responsive">
              <table id="devicesTable" class="table table-hover nowrap" style="width:100%">
                <thead class="table-light">
                  <tr>
                    <th>Hostname</th>
                    <th>OS</th>
                    <th>Type</th>
                    <th>Status</th>
                    <th class="text-end">CPU</th>
                    <th class="text-end">RAM</th>
                    <th class="text-end">Disk</th>
                    <th class="text-end">Ping</th>
                    <th class="text-end">Last check-in</th>
                    <th class="text-center">Actions</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

          </div>
        </div>
      </section>

      <section id="view-pending" class="view" style="display:none;">
        <div class="mb-3 d-flex justify-content-between align-items-center">
          <div>
            <h5 class="mb-0">Pending Adoption</h5>
            <div class="small-muted">Devices waiting for admin approval</div>
          </div>
          <div id="pendingActions">
            <button id="approveSelected" class="btn btn-success btn-sm">Approve selected</button>
            <button id="approveAll" class="btn btn-primary btn-sm">Approve all</button>
            <button id="reloadPending" class="btn btn-outline-secondary btn-sm">Reload</button>
          </div>
        </div>

        <div class="card">
          <div class="card-body">
            <div class="table-responsive">
              <table id="pendingTable" class="table table-hover nowrap" style="width:100%">
                <thead class="table-light">
                  <tr>
                    <th><input id="pendingSelectAll" type="checkbox"></th>
                    <th>Pending ID</th>
                    <th>Hostname</th>
                    <th>OS</th>
                    <th class="text-end">CPU</th>
                    <th class="text-end">RAM</th>
                    <th class="text-end">Disk</th>
                    <th class="text-end">Last seen</th>
                    <th class="text-center">Actions</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <section id="view-health" class="view" style="display:none;">
        <div class="mb-3 d-flex justify-content-between align-items-center">
          <div>
            <h5 class="mb-0">Health Dashboard</h5>
            <div class="small-muted">Overview of failing indicators</div>
          </div>
          <div>
            <button id="reloadHealth" class="btn btn-outline-secondary btn-sm">Reload</button>
          </div>
        </div>

        <div class="row g-3 mb-3">
          <div class="col-12 col-lg-8">
            <div class="card">
              <div class="card-body">
                <h6>Devices with Problems</h6>
                <div class="table-responsive">
                  <table id="healthTable" class="table table-hover nowrap" style="width:100%">
                    <thead class="table-light">
                      <tr>
                        <th>Hostname</th>
                        <th>Issue</th>
                        <th class="text-end">CPU</th>
                        <th class="text-end">Disk Free</th>
                        <th class="text-end">Last check-in</th>
                        <th class="text-center">Actions</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <div class="col-12 col-lg-4">
            <div class="card mb-3">
              <div class="card-body">
                <h6>Summary</h6>
                <div class="small-muted">Total devices: <span id="health-total">—</span></div>
                <div class="small-muted">Devices with alerts: <span id="health-alerts">—</span></div>
                <div class="small-muted">Low disk ( &lt; 10% ): <span id="health-lowdisk">—</span></div>
                <div class="small-muted">High CPU ( &gt; 90% ): <span id="health-highcpu">—</span></div>
              </div>
            </div>

            <div class="card">
              <div class="card-body">
                <h6>Filters</h6>
                <div class="form-check mb-2">
                  <input id="filterLowDisk" class="form-check-input" type="checkbox">
                  <label class="form-check-label" for="filterLowDisk">Low disk (&lt;10%)</label>
                </div>
                <div class="form-check mb-2">
                  <input id="filterHighCpu" class="form-check-input" type="checkbox">
                  <label class="form-check-label" for="filterHighCpu">High CPU (&gt;90%)</label>
                </div>
                <div class="form-check mb-2">
                  <input id="filterUpdates" class="form-check-input" type="checkbox">
                  <label class="form-check-label" for="filterUpdates">Updates available</label>
                </div>
              </div>
            </div>

          </div>
        </div>
      </section>

    </main>
  </div>

  <!-- Alerts -->
  <div id="alerts" style="position:fixed; top:1rem; right:1rem; z-index:1200;"></div>

  <!-- Dependencies -->
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>

  <script>
    function showAlert(msg, type = 'success', timeout = 3500) {
      const id = 'a' + Date.now();
      const el = $(`<div id="${id}" class="alert alert-${type} shadow-sm" role="alert" style="min-width:260px;">${msg}</div>`);
      $('#alerts').append(el);
      setTimeout(() => el.fadeOut(300, () => el.remove()), timeout);
    }

    function fmtPercent(num) {
      if (num == null) return '—';
      const v = Number(num);
      if (Number.isFinite(v)) return v.toFixed(1) + '%';
      return '—';
    }

    function fmtPctFromUsed(used, total) {
      if (!total || total === 0) return '—';
      return ((used / total) * 100).toFixed(1) + '%';
    }

    // DataTables instances
    const devicesTable = $('#devicesTable').DataTable({
      responsive: true,
      columns: [
        { data: 'hostname', render: (d, t, r) => `<a href="#" class="device-link" data-id="${r.device_name || r.id || ''}">${d || r.device_name || '—'}</a>` },
        { data: 'os_name' },
        { data: 'device_type', render: d => `<div class="device-type">${d || '—'}</div>` },
        { data: null, render: d => {
            if (d.pending) return `<span class="badge badge-pending">Pending</span>`;
            const last = d.last_checkin ? new Date(d.last_checkin) : null;
            if (!last) return `<span class="small-muted">Offline</span>`;
            const diff = (Date.now() - new Date(last)) / 1000;
            if (diff < 600) return `<span><span class="status-dot status-online"></span>Online</span>`;
            return `<span><span class="status-dot status-offline"></span>Offline</span>`;
          }
        },
        { data: 'cpu_usage', className: 'text-end', render: d => fmtPercent(d) },
        { data: null, className: 'text-end', render: d => fmtPctFromUsed(d.ram_used, d.ram_total) },
        { data: null, className: 'text-end', render: d => {
            if (!d.disk_total || d.disk_total === 0) return '—';
            return `${(((d.disk_total - d.disk_free) / d.disk_total) * 100).toFixed(1)}%`;
          } },
        { data: 'ping_latency', className: 'text-end', render: d => (d != null ? `${d} ms` : '—') },
        { data: 'last_checkin', className: 'text-end', render: d => (d ? new Date(d).toLocaleString() : '—') },
        { data: null, orderable:false, searchable:false, className:'text-center', render: d => {
            const canonicalId = d.device_name || d.id || '';
            let actions = `<div class="table-actions">`;
            actions += `<button class="btn btn-sm btn-outline-primary btn-compact view-btn" data-id="${canonicalId}" title="View"><i class="bi bi-eye"></i></button>`;
            if (d.pending) {
              actions += ` <button class="btn btn-sm btn-warning btn-compact approve-btn" data-id="${canonicalId}" data-host="${d.hostname || canonicalId}" title="Approve"><i class="bi bi-check2"></i> Approve</button>`;
            } else {
              actions += ` <div class="btn-group"><button class="btn btn-sm btn-outline-secondary btn-compact dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi bi-three-dots"></i></button><ul class="dropdown-menu dropdown-menu-end"><li><a class="dropdown-item force-checkin" data-id="${canonicalId}" href="#">Force Check-in</a></li><li><a class="dropdown-item force-patch" data-id="${canonicalId}" href="#">Force Patch</a></li></ul></div>`;
            }
            actions += `</div>`;
            return actions;
          }
        }
      ],
      pageLength: 25,
      deferRender: true,
      language: { emptyTable: 'No devices yet — check registration / heartbeat' }
    });

    const pendingTable = $('#pendingTable').DataTable({
      responsive: true,
      columns: [
        { data: null, orderable:false, render: (d) => `<input class="pending-checkbox" data-id="${d.id||d.device_name||''}" type="checkbox">` },
        { data: 'id' },
        { data: 'hostname' },
        { data: 'os_name' },
        { data: 'cpu_usage', className:'text-end', render: d => fmtPercent(d) },
        { data: null, className:'text-end', render: d => fmtPctFromUsed(d.ram_used, d.ram_total) },
        { data: null, className:'text-end', render: d => {
            if (!d.disk_total || d.disk_total===0) return '—';
            return `${(((d.disk_total - d.disk_free) / d.disk_total) * 100).toFixed(1)}%`;
          }
        },
        { data: 'last_checkin', className:'text-end', render: d => (d ? new Date(d).toLocaleString() : '—') },
        { data: null, orderable:false, className:'text-center', render: d => `<button class="btn btn-sm btn-success approve-single" data-id="${d.id||d.device_name||''}"><i class="bi bi-check2"></i></button>` }
      ],
      pageLength: 25,
      deferRender: true
    });

    const healthTable = $('#healthTable').DataTable({
      responsive: true,
      columns: [
        { data: 'hostname' },
        { data: 'issue' },
        { data: 'cpu_usage', className:'text-end', render: d => fmtPercent(d) },
        { data: 'disk_free_pct', className:'text-end', render: d => (d==null ? '—' : `${d.toFixed(1)}%`) },
        { data: 'last_checkin', className:'text-end', render: d => (d ? new Date(d).toLocaleString() : '—') },
        { data: null, orderable:false, className:'text-center', render: d => `<button class="btn btn-sm btn-outline-primary btn-compact view-btn" data-id="${d.device_name||d.id||''}"><i class="bi bi-eye"></i></button>` }
      ],
      pageLength: 25,
      deferRender: true
    });

    // Data storage
    let ALL_DEVICES = [];

    async function fetchDevices() {
      const res = await fetch('/api/devices');
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return await res.json();
    }

    async function reloadAll() {
      try {
        const devices = await fetchDevices();
        ALL_DEVICES = devices;
        populateDevicesView(devices);
        populatePendingView(devices);
        populateHealthView(devices);
        $('#lastRefresh').text(new Date().toLocaleTimeString());
      } catch (err) {
        console.error(err);
        showAlert('Failed to load devices', 'danger', 4500);
      }
    }

    function populateDevicesView(devices) {
      const total = devices.length;
      let online = 0, pending = 0, updates = 0;
      devices.forEach(d => {
        if (d.pending) pending++;
        else {
          const last = d.last_checkin ? new Date(d.last_checkin) : null;
          if (last && (Date.now() - last) / 1000 < 600) online++;
        }
        if (d.updates_available) updates++;
      });

      $('#totalDevices').text(total);
      $('#onlineDevices').text(online);
      $('#pendingCount').text(pending);
      $('#updatesAvailable').text(updates);

      const normalized = devices.map(d => ({
        id: d.id ?? null,
        device_name: d.device_name ?? null,
        hostname: d.hostname || d.device_name || d.id || '',
        os_name: d.os_name || '',
        device_type: d.device_type || d.device_model || '',
        cpu_usage: d.cpu_usage ?? null,
        ram_total: d.ram_total ?? 0,
        ram_used: d.ram_used ?? 0,
        disk_total: d.disk_total ?? 0,
        disk_free: d.disk_free ?? 0,
        disk_health: d.disk_health || '',
        network_throughput: d.network_throughput ?? 0,
        ping_latency: d.ping_latency ?? null,
        last_checkin: d.last_checkin ?? null,
        updates_available: d.updates_available ?? false,
        approved: d.approved ?? false,
        pending: d.pending ?? false,
        device_model: d.device_model || '',
        ip_address: d.ip_address || null,
        network_interfaces: d.network_interfaces || null
      }));

      devicesTable.clear().rows.add(normalized).draw(false);
    }

    function populatePendingView(devices) {
      const pending = devices.filter(d => d.pending);
      $('#pendingCount').text(pending.length);
      const normalized = pending.map(d => ({
        id: d.device_name || d.id || '',
        hostname: d.hostname || d.device_name || d.id || '',
        os_name: d.os_name || '',
        cpu_usage: d.cpu_usage ?? null,
        ram_total: d.ram_total ?? 0,
        ram_used: d.ram_used ?? 0,
        disk_total: d.disk_total ?? 0,
        disk_free: d.disk_free ?? 0,
        last_checkin: d.last_checkin ?? null
      }));
      pendingTable.clear().rows.add(normalized).draw(false);
    }

    function populateHealthView(devices) {
      const alerts = [];
      devices.forEach(d => {
        if (!d) return;
        const issues = [];
        // Check disk %
        if (d.disk_total && d.disk_total > 0) {
          const free_pct = (d.disk_free / d.disk_total) * 100;
          if (free_pct < 10) issues.push('Low disk');
        }
        if (d.cpu_usage != null && d.cpu_usage > 90) issues.push('High CPU');
        if (d.disk_health && d.disk_health.toLowerCase().includes('fail')) issues.push('Disk health failing');
        if (d.updates_available) issues.push('Updates available');

        if (issues.length) {
          alerts.push({
            id: d.device_name || d.id || '',
            device_name: d.device_name || d.id || '',
            hostname: d.hostname || d.device_name || d.id || '',
            issue: issues.join(', '),
            cpu_usage: d.cpu_usage ?? null,
            disk_free_pct: (d.disk_total && d.disk_total > 0) ? ((d.disk_free / d.disk_total) * 100) : null,
            last_checkin: d.last_checkin ?? null
          });
        }
      });

      $('#health-total').text(devices.length);
      $('#health-alerts').text(alerts.length);
      $('#health-lowdisk').text(alerts.filter(a => a.issue.includes('Low disk')).length);
      $('#health-highcpu').text(alerts.filter(a => a.issue.includes('High CPU')).length);

      healthTable.clear().rows.add(alerts).draw(false);
    }

    // Approve single pending entry
    async function approveDevice(id) {
      try {
        const res = await fetch(`/api/devices/${encodeURIComponent(id)}/approve`, { method: 'POST' });
        if (!res.ok) {
          const txt = await res.text().catch(()=>'');
          throw new Error(`HTTP ${res.status} ${txt}`);
        }
        showAlert(`Approved ${id}`, 'success', 2000);
        await reloadAll();
      } catch (err) {
        console.error(err);
        showAlert(`Failed to approve ${id}`, 'danger', 4500);
      }
    }

    // Approve multiple
    async function approveDevicesBulk(ids) {
      if (!ids || ids.length === 0) return;
      try {
        const promises = ids.map(id => fetch(`/api/devices/${encodeURIComponent(id)}/approve`, { method: 'POST' }));
        const results = await Promise.allSettled(promises);
        const failed = results.filter(r => r.status === 'rejected' || (r.status === 'fulfilled' && r.value && !r.value.ok)).length;
        if (failed === 0) showAlert('Approved selected devices', 'success', 2200);
        else showAlert('Some approvals failed', 'warning', 4000);
        await reloadAll();
      } catch (err) {
        console.error(err);
        showAlert('Bulk approve failed', 'danger', 4500);
      }
    }

    // UI bindings
    $('#btnRefresh, #refreshNav').on('click', reloadAll);
    $('#reloadPending').on('click', () => populatePendingView(ALL_DEVICES));
    $('#reloadHealth').on('click', () => populateHealthView(ALL_DEVICES));

    // approve single row in pending
    $('body').on('click', '.approve-single', function() {
      const id = $(this).data('id');
      if (!id) return;
      approveDevice(id);
    });

    // approve button from devices view
    $('body').on('click', '.approve-btn', function() {
      const id = $(this).data('id');
      if (!id) return;
      approveDevice(id);
    });

    // approve all / selected in pending
    $('#approveAll').on('click', async () => {
      const ids = ALL_DEVICES.filter(d => d.pending).map(d => d.device_name || d.id).filter(Boolean);
      if (!ids.length) { showAlert('No pending devices', 'info'); return; }
      if (!confirm(`Approve ${ids.length} devices?`)) return;
      await approveDevicesBulk(ids);
    });

    $('#approveSelected').on('click', async () => {
      const ids = [];
      $('#pendingTable .pending-checkbox:checked').each(function() {
        ids.push($(this).data('id'));
      });
      if (!ids.length) { showAlert('No devices selected', 'info'); return; }
      if (!confirm(`Approve ${ids.length} selected devices?`)) return;
      await approveDevicesBulk(ids);
    });

    // pending select all
    $('#pendingSelectAll').on('change', function() {
      const checked = $(this).is(':checked');
      $('#pendingTable .pending-checkbox').prop('checked', checked);
    });

    // select row checkboxes are re-rendered by DataTables; keep delegated listener
    $('body').on('change', '#pendingTable .pending-checkbox', function() {
      // noop — presence is enough for approveSelected to collect checked ones
    });

    // Device detail view open
    $('body').on('click', '.view-btn, .device-link', function(e) {
      e.preventDefault();
      const id = $(this).data('id');
      if (!id) return;
      window.open(`/device_detail.html?deviceID=${encodeURIComponent(id)}`, '_blank');
    });

    // Force placeholders
    $('body').on('click', '.force-checkin, .force-patch', function(e) {
      e.preventDefault();
      const id = $(this).data('id');
      showAlert(`Action requested for ${id}`, 'info', 2200);
    });

    // Sidebar nav switching
    $('#navList .nav-item').on('click keypress', function(e) {
      if (e.type === 'keypress' && e.key !== 'Enter') return;
      const view = $(this).data('view');
      if (!view) return;
      $('#navList .nav-item').removeClass('active');
      $(this).addClass('active');
      $('.view').hide();
      $(`#view-${view}`).show();
      // load specific view data on demand
      if (view === 'devices') populateDevicesView(ALL_DEVICES);
      if (view === 'pending') populatePendingView(ALL_DEVICES);
      if (view === 'health') populateHealthView(ALL_DEVICES);
    });

    // Sidebar collapse
    const sidebar = document.getElementById('sidebar');
    const toggleBtn = document.getElementById('toggleSidebar');
    const toggleIcon = document.getElementById('toggleIcon');
    function setCollapsed(collapsed) {
      if (collapsed) {
        sidebar.classList.add('collapsed');
        toggleIcon.innerHTML = '<i class="bi bi-chevron-right"></i>';
        localStorage.setItem('pp_sidebar_collapsed','1');
      } else {
        sidebar.classList.remove('collapsed');
        toggleIcon.innerHTML = '<i class="bi bi-chevron-left"></i>';
        localStorage.removeItem('pp_sidebar_collapsed');
      }
    }
    toggleBtn.addEventListener('click', () => setCollapsed(!sidebar.classList.contains('collapsed')));
    if (localStorage.getItem('pp_sidebar_collapsed')) setCollapsed(true);

    // Dark toggle simple
    $('#btnToggleDark').on('click', () => {
      document.body.classList.toggle('dark');
      const dark = document.body.classList.contains('dark');
      localStorage.setItem('pp_dark', dark ? '1' : '0');
    });
    if (localStorage.getItem('pp_dark') === '1') document.body.classList.add('dark');

    // initial load
    $(document).ready(async () => {
      await reloadAll();
      // periodic refresh every 30s when on devices view
      setInterval(async () => {
        const active = $('#navList .nav-item.active').data('view') || 'devices';
        if (active === 'devices' || active === 'pending' || active === 'health') await reloadAll();
      }, 30000);
    });
  </script>
</body>
</html>
