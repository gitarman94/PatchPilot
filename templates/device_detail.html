<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Device Details - PatchPilot</title>

    <!-- Bootstrap 5 -->
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
          crossorigin="anonymous">

    <!-- Font Awesome -->
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
          crossorigin="anonymous"/>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { background: #f4f4f9; color: #333; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .container { max-width: 1200px; margin: auto; padding-top: 20px; }
        .card { margin-bottom: 20px; }
        .card-header { font-weight: bold; background-color: #f8f9fa; }
        .card-body { background-color: #ffffff; }
        .chart-container { position: relative; height: 300px; width: 100%; }
        .status-updates { color: #ffc107; font-weight: bold; }
        .status-online { color: #28a745; }
        .status-offline { color: #dc3545; }
        .status-text { font-size: 18px; font-weight: 500; }
    </style>
</head>
<body>

<div class="container">
    <h1 class="mb-4">Device: <span id="deviceName">Loading...</span></h1>

    <!-- Device Info -->
    <div class="card">
        <div class="card-header">General Information</div>
        <div class="card-body">
            <p><strong>Device ID:</strong> <span id="deviceID">Loading...</span></p>
            <p><strong>OS:</strong> <span id="osName">Loading...</span></p>
            <p><strong>Uptime:</strong> <span id="uptime">Loading...</span></p>
            <p><strong>Last Check-in:</strong> <span id="lastCheckin">Loading...</span></p>
            <p><strong>Status:</strong> <span id="deviceStatus">Loading...</span></p>
            <p><strong>Network Throughput:</strong> <span id="networkThroughput">Loading...</span></p>
        </div>
    </div>

    <!-- Hardware Info -->
    <div class="card">
        <div class="card-header">Hardware Details</div>
        <div class="card-body">
            <p><strong>CPU Cores:</strong> <span id="cpuCores">Loading...</span></p>
            <p><strong>CPU Usage:</strong> <span id="cpuUsage">Loading...</span>%</p>
            <p><strong>RAM Usage:</strong> <span id="ramUsage">Loading...</span>%</p>
            <p><strong>Disk Usage:</strong> <span id="diskUsage">Loading...</span>%</p>
            <p><strong>Disk Health:</strong> <span id="diskHealth">Loading...</span></p>
            <p><strong>Battery Health:</strong> <span id="batteryHealth">Loading...</span></p>
            <p><strong>GPU:</strong> <span id="gpu">Loading...</span></p>
        </div>
    </div>

    <!-- Network Info -->
    <div class="card">
        <div class="card-header">Network Details</div>
        <div class="card-body">
            <p><strong>Wi-Fi Status:</strong> <span id="wifiStatus">Loading...</span></p>
            <p><strong>IP Address:</strong> <span id="ipAddress">Loading...</span></p>
            <p><strong>MAC Address:</strong> <span id="macAddress">Loading...</span></p>
        </div>
    </div>

    <!-- System Stats (Charts) -->
    <div class="card">
        <div class="card-header">System Stats</div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <h5>CPU Usage</h5>
                    <div class="chart-container" id="cpuUsageChart"></div>
                </div>
                <div class="col-md-4">
                    <h5>RAM Usage</h5>
                    <div class="chart-container" id="ramUsageChart"></div>
                </div>
                <div class="col-md-4">
                    <h5>Disk Usage</h5>
                    <div class="chart-container" id="diskUsageChart"></div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- JS Dependencies -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

<script>
    $(document).ready(function() {
        const deviceID = new URLSearchParams(window.location.search).get('deviceID'); // Extract device ID from URL

        // Function to load device details
        async function loadDeviceDetails() {
            try {
                const response = await fetch(`/api/device/${deviceID}`);
                const data = await response.json();

                if (!data.success) {
                    $('#deviceName').text('Error: Device not found');
                    return;
                }

                const device = data.device;

                // Fill the fields
                $('#deviceName').text(device.device_name);
                $('#deviceID').text(device.id);
                $('#osName').text(device.os_name);
                $('#uptime').text(device.uptime ? `${device.uptime} seconds` : 'N/A');
                $('#lastCheckin').text(device.last_checkin ? new Date(device.last_checkin).toLocaleString() : 'N/A');
                $('#deviceStatus').text(device.is_online ? 'Online' : 'Offline').addClass(device.is_online ? 'status-online' : 'status-offline');
                $('#networkThroughput').text(device.network_throughput || 'N/A');

                // Hardware info
                $('#cpuCores').text(device.cpu_cores || 'N/A');
                $('#cpuUsage').text(device.cpu_usage ? device.cpu_usage.toFixed(2) : 'N/A');
                $('#ramUsage').text(device.ram_usage ? `${device.ram_usage.toFixed(2)}%` : 'N/A');
                $('#diskUsage').text(device.disk_usage ? `${device.disk_usage.toFixed(2)}%` : 'N/A');
                $('#diskHealth').text(device.disk_health || 'N/A');
                $('#batteryHealth').text(device.battery_health || 'N/A');
                $('#gpu').text(device.gpu || 'N/A');

                // Network info
                $('#wifiStatus').text(device.wifi_status || 'N/A');
                $('#ipAddress').text(device.ip_address || 'N/A');
                $('#macAddress').text(device.mac_address || 'N/A');

                // Render charts
                renderChart('cpuUsageChart', 'CPU Usage', 'CPU Usage (%)', device.cpu_usage_history || []);
                renderChart('ramUsageChart', 'RAM Usage', 'RAM Usage (%)', device.ram_usage_history || []);
                renderChart('diskUsageChart', 'Disk Usage', 'Disk Usage (%)', device.disk_usage_history || []);
            } catch (error) {
                console.error('Error loading device details:', error);
                $('#deviceName').text('Failed to load device details');
            }
        }

        // Function to render charts
        function renderChart(elementId, label, title, data) {
            const ctx = document.getElementById(elementId).getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map((_, index) => `T${index + 1}`), // Time labels
                    datasets: [{
                        label: title,
                        data: data,
                        borderColor: '#4e73df',
                        tension: 0.1,
                        fill: false,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: { display: true, text: label },
                        tooltip: { enabled: true }
                    },
                    scales: {
                        x: { title: { display: true, text: 'Time' } },
                        y: { title: { display: true, text: title } }
                    }
                }
            });
        }

        // Load device details
        loadDeviceDetails();
    });
</script>
</body>
</html>
